{% extends "base.html" %}

{% block title %}{{ recipe.name }} - Recipe Management System{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-start mb-4">
            <div>
                <h1 class="display-6 mb-2">{{ recipe.name }}</h1>
                <p class="text-muted">{{ recipe.description or 'No description available' }}</p>
            </div>
            <div class="text-end">
                <span class="ingredient-badge fs-6">{{ recipe.servings }} servings</span>
                {% if recipe.whole_unit %}
                <br><span class="badge bg-warning text-dark mt-1">
                    <i class="bi bi-pie-chart"></i> Whole Unit Recipe
                </span>
                {% endif %}
                {% if allergens %}
                <br><div class="mt-2">
                    <strong class="d-block mb-1" style="font-size: 0.9em;">⚠️ Contains Allergens:</strong>
                    {% for allergen in allergens %}
                    <span class="badge bg-danger me-1" title="{{ allergen.description }}">
                        {{ allergen.icon }} {{ allergen.name }}
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<div class="row">
    <!-- Recipe Info -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-info-circle"></i> Recipe Info</h5>
            </div>
            <div class="card-body">
                {% if cost_data %}
                <!-- Prep Factor at top -->
                <div class="mb-3 p-3 bg-light rounded">
                    <div class="d-flex align-items-center justify-content-between mb-2">
                        <strong><i class="bi bi-gear"></i> Prep Factor:</strong>
                        <div class="d-flex align-items-center gap-2">
                            <div class="input-group input-group-sm" style="max-width: 100px;">
                                <input type="number" class="form-control form-control-sm" id="prep_factor_input"
                                       value="{{ (cost_data.prep_factor * 100)|round(1) }}"
                                       min="0" max="100" step="0.1">
                                <span class="input-group-text">%</span>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="updatePrepFactor()">
                                <i class="bi bi-check"></i>
                            </button>
                        </div>
                    </div>
                    <small class="text-muted">
                        <i class="bi bi-info-circle"></i> Covers labor, equipment, planning, and special preparation needs.
                    </small>
                </div>
                {% endif %}

                <div class="row text-center mb-3">
                    {% if recipe.prep_time > 0 %}
                    <div class="col-6">
                        <div class="stats-card p-3 rounded">
                            <i class="bi bi-clock display-6 mb-2"></i>
                            <h4>{{ recipe.prep_time }}m</h4>
                            <small class="opacity-75">Prep Time</small>
                        </div>
                    </div>
                    {% endif %}
                    {% if recipe.cook_time > 0 %}
                    <div class="col-6">
                        <div class="stats-card p-3 rounded">
                            <i class="bi bi-fire display-6 mb-2"></i>
                            <h4>{{ recipe.cook_time }}m</h4>
                            <small class="opacity-75">Cook Time</small>
                        </div>
                    </div>
                    {% endif %}
                </div>

                {% if cost_data %}
                <div class="cost-highlight text-center mb-3">
                    <h5 class="mb-1">${{ cost_data.cost_per_serving }} per serving</h5>
                    <small>Total: ${{ cost_data.total_cost }} (includes {{ (cost_data.prep_factor * 100)|round(1) }}% prep overhead)</small>
                </div>
                {% endif %}

                <div class="d-grid gap-2">
                    <button class="btn btn-primary" onclick="showScaleModal()">
                        <i class="bi bi-arrows-fullscreen"></i> Scale Recipe
                    </button>
                    <button class="btn btn-outline-secondary" onclick="printRecipe()">
                        <i class="bi bi-printer"></i> Print Recipe
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ingredients -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-bag"></i> Ingredients</h5>
                <a href="{{ url_for('add_ingredient_to_recipe', recipe_name=recipe.name) }}" class="btn btn-sm btn-outline-primary">
                    <i class="bi bi-plus"></i> Add Ingredient
                </a>
            </div>
            <div class="card-body">
                {% if recipe_ingredients %}
                <div class="table-responsive">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Ingredient</th>
                                <th>Quantity</th>
                                <th>Unit</th>
                                {% if cost_data %}
                                <th>Cost</th>
                                {% endif %}
                            </tr>
                        </thead>
                        <tbody>
                            {% for ingredient in recipe_ingredients %}
                            <tr>
                                <td>{{ ingredient.ingredient_name }}</td>
                                <td>{{ ingredient.quantity }}</td>
                                <td>{{ ingredient.unit }}</td>
                                {% if cost_data %}
                                    {% set ing_cost = cost_data.ingredient_breakdown | selectattr('name', 'equalto', ingredient.ingredient_name) | first %}
                                    <td>${{ ing_cost.cost if ing_cost else '0.00' }}</td>
                                {% endif %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <div class="text-center py-4">
                    <i class="bi bi-bag-x display-4 text-muted"></i>
                    <h6 class="text-muted mt-3">No ingredients added yet</h6>
                    <a href="{{ url_for('add_ingredient_to_recipe', recipe_name=recipe.name) }}" class="btn btn-primary">
                        <i class="bi bi-plus"></i> Add First Ingredient
                    </a>
                </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Cooking Instructions -->
{% if recipe.instructions %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0"><i class="bi bi-list-ol"></i> Cooking Instructions</h5>
                <button class="btn btn-sm btn-outline-secondary" onclick="toggleInstructionsFormat()">
                    <i class="bi bi-arrow-repeat"></i> Toggle Format
                </button>
            </div>
            <div class="card-body">
                <div id="instructionsFormatted" class="instructions-formatted">
                    <!-- Instructions will be formatted by JavaScript -->
                </div>
                <div id="instructionsRaw" class="instructions-raw d-none">
                    <pre class="mb-0">{{ recipe.instructions }}</pre>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Cost Breakdown -->
{% if cost_data %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0"><i class="bi bi-graph-up"></i> Cost Breakdown</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <table class="table table-sm">
                            <tr>
                                <td>Ingredient Cost:</td>
                                <td class="text-end">${{ "%.2f"|format(cost_data.ingredient_cost) }}</td>
                            </tr>
                            <tr>
                                <td>Prep Factor ({{ (cost_data.prep_factor * 100)|round(1) }}%):</td>
                                <td class="text-end">${{ "%.2f"|format(cost_data.prep_factor_cost) }}</td>
                            </tr>
                            <tr class="fw-bold border-top">
                                <td>Total Cost:</td>
                                <td class="text-end">${{ "%.2f"|format(cost_data.total_cost) }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <div class="text-center">
                            <canvas id="costChart" width="200" height="200"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Navigation -->
<div class="row mt-4">
    <div class="col-12">
        <div class="d-flex justify-content-between">
            <a href="{{ url_for('recipes') }}" class="btn btn-outline-secondary">
                <i class="bi bi-arrow-left"></i> Back to Recipes
            </a>
            <div>
                <button class="btn btn-outline-danger me-2" onclick="deleteRecipe()">
                    <i class="bi bi-trash"></i> Delete Recipe
                </button>
                <button class="btn btn-secondary" onclick="editRecipe()">
                    <i class="bi bi-pencil"></i> Edit Recipe
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Scale Recipe Modal -->
<div class="modal fade" id="scaleModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Scale Recipe</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="newServings" class="form-label">Number of Servings</label>
                    <input type="number" class="form-control" id="newServings" value="{{ recipe.servings }}" min="1" max="100">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="scaleRecipe()">Scale Recipe</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_css %}
<style>
.instructions-formatted {
    font-size: 1.1rem;
    line-height: 1.8;
}

.instructions-formatted ol {
    padding-left: 1.5rem;
}

.instructions-formatted li {
    margin-bottom: 0.75rem;
    padding-left: 0.5rem;
}

.instructions-formatted li:last-child {
    margin-bottom: 0;
}

.instruction-step {
    background: #f8f9fa;
    border-left: 4px solid var(--primary-color);
    padding: 1rem;
    margin-bottom: 0.75rem;
    border-radius: 0 8px 8px 0;
}

.instruction-step:last-child {
    margin-bottom: 0;
}

.instruction-number {
    font-weight: bold;
    color: var(--primary-color);
    font-size: 1.2rem;
}

.instructions-raw pre {
    background: #f8f9fa;
    padding: 1rem;
    border-radius: 8px;
    border: 1px solid #e9ecef;
}
</style>
{% endblock %}

{% block extra_js %}
<script>
// Format instructions on page load
document.addEventListener('DOMContentLoaded', function() {
    formatInstructions();
});

function formatInstructions() {
    const rawInstructions = `{{ recipe.instructions|safe }}`;
    const formattedDiv = document.getElementById('instructionsFormatted');

    if (!rawInstructions.trim()) {
        formattedDiv.innerHTML = '<p class="text-muted">No instructions provided.</p>';
        return;
    }

    // Split by lines and process
    const lines = rawInstructions.split('\n');
    let formattedHTML = '';
    let stepNumber = 1;

    lines.forEach(line => {
        line = line.trim();
        if (!line) return; // Skip empty lines

        // Check if line starts with a number (already numbered step)
        const numberedMatch = line.match(/^(\d+)\.?\s*(.+)/);
        if (numberedMatch) {
            const stepText = numberedMatch[2];
            formattedHTML += `
                <div class="instruction-step">
                    <span class="instruction-number">${numberedMatch[1]}.</span> ${stepText}
                </div>
            `;
        } else {
            // Auto-number the step
            formattedHTML += `
                <div class="instruction-step">
                    <span class="instruction-number">${stepNumber}.</span> ${line}
                </div>
            `;
            stepNumber++;
        }
    });

    formattedDiv.innerHTML = formattedHTML;
}

function toggleInstructionsFormat() {
    const formatted = document.getElementById('instructionsFormatted');
    const raw = document.getElementById('instructionsRaw');

    if (formatted.classList.contains('d-none')) {
        formatted.classList.remove('d-none');
        raw.classList.add('d-none');
    } else {
        formatted.classList.add('d-none');
        raw.classList.remove('d-none');
    }
}

function showScaleModal() {
    const modal = new bootstrap.Modal(document.getElementById('scaleModal'));
    modal.show();
}

function scaleRecipe() {
    const newServings = document.getElementById('newServings').value;
    window.location.href = `/scale_recipe/{{ recipe.name }}?servings=${newServings}`;
}

// Add ingredient functionality now handled by direct link

function editRecipe() {
    window.location.href = '/recipe/{{ recipe.name }}/edit';
}

function deleteRecipe() {
    if (confirm('Are you sure you want to delete this recipe? This action cannot be undone.')) {
        // Create a form and submit it
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = '/recipe/{{ recipe.name }}/delete';
        document.body.appendChild(form);
        form.submit();
    }
}

function printRecipe() {
    window.print();
}

function updatePrepFactor() {
    const prepFactorPercent = parseFloat(document.getElementById('prep_factor_input').value);
    const prepFactorDecimal = prepFactorPercent / 100.0;

    // Create form and submit
    const form = document.createElement('form');
    form.method = 'POST';
    form.action = '{{ url_for("update_recipe_prepfactor", recipe_name=recipe.name) }}';

    const input = document.createElement('input');
    input.type = 'hidden';
    input.name = 'prep_factor';
    input.value = prepFactorDecimal;

    form.appendChild(input);
    document.body.appendChild(form);
    form.submit();
}

// Simple cost chart if data is available
{% if cost_data %}
document.addEventListener('DOMContentLoaded', function() {
    // This is where you could add a Chart.js pie chart
    // For now, just showing the data is available
});
{% endif %}
</script>
{% endblock %}